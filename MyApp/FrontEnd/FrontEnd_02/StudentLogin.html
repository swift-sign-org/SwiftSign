<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Login</title>
  <link rel="icon" href="001.PNG" type="image/png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="vue.global.js"></script>
  <!-- Vue 3 CDN (global build) -->
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="style.css">

</head>
<body>
    <body>
        <div id="loginApp">
          <section>
            <div class="login-box">
              <form @submit.prevent="login">
                <h2>Login with Email</h2>
      
                <div class="input-box">
                  <input type="email" 
                         v-model="email" 
                         @keyup.enter="login"
                         :disabled="isSubmitting"
                         required>
                  <label>üìß Email Address</label>
                </div>
      
                <button type="submit" class="button" :disabled="isSubmitting" style="color: black;" >
                  <i class="bi bi-box-arrow-in-right"></i>
                  <span v-if="isSubmitting">Processing...</span>
                  <span v-else>Login</span>
                </button>
      
                <div class="message success" v-if="loginSuccess">
                  ‚úÖ {{ successMessage }}
                </div>
      
                <div class="message error" v-if="loginError">
                  ‚ùå {{ errorMessage }}
                </div>
              </form>
            </div>
          </section>
      
          <!-- Error Popup -->
          <div class="error-popup" v-if="loginError">
            <div class="close-btn" @click="loginError = false">&times;</div>
            <div class="error-popup-title">
              <i class="bi bi-exclamation-triangle-fill"></i> Error
            </div>
            <div>{{ errorMessage }}</div>
          </div>
        </div>
      
        <!-- Ionicons & Vue -->
        <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
        <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
      
        <!-- Your Vue Script Here (same as before) -->
        <script>
            // Initialize the Vue application
            new Vue({
              el: '#loginApp',
              
              // Application data and state management
              data() {
                return {
                  email: '',                  // User's email input
                  loginSuccess: false,        // Flag for successful login
                  loginError: false,          // Flag for error display
                  successMessage: 'Login Successful!', // Success notification text
                  errorMessage: '',           // Error message content
                  isSubmitting: false,        // Form submission state
                  redirectUrl: "/attendance"  // Redirect location after successful login
                };
              },
              
              // Lifecycle hook - runs when Vue instance is created
              created() {
                // Restore dark mode preference from local storage
                const savedMode = localStorage.getItem("darkMode");
                this.isDarkMode = savedMode === "true";
                document.body.classList.toggle("dark-mode", this.isDarkMode);
              },
              
              methods: {
                // Display error messages in popup
                showError(message) {
                  this.loginError = true;
                  this.errorMessage = message;
                  this.loginSuccess = false;
                  
                  // Auto-hide error after 5 seconds
                  setTimeout(() => {
                    this.loginError = false;
                  }, 5000);
                },
                
                // Handle login form submission
                async login() {
                  // Prevent duplicate submissions
                  if (this.isSubmitting) return;
        
                  // Validate email format
                  const emailTrimmed = this.email.trim();
                  const domain = "@hns-re2sd.dz";
        
                  if (!emailTrimmed) {
                    this.showError("Please enter your email.");
                    return;
                  }
        
                  if (!emailTrimmed.endsWith(domain)) {
                    this.showError(`Email must end with ${domain}`);
                    return;
                  }
        
                  // Process login request
                  this.isSubmitting = true;
                  
                  try {
                    // Use new API endpoint for student login
                    const response = await fetch("/api/students/login", {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/json"
                      },
                      body: JSON.stringify({ email: emailTrimmed })
                    });
                    
                    const data = await response.json();
                    
                    // Handle successful response
                    if (response.ok) {
                      // Show success message
                      this.loginSuccess = true;
                      this.successMessage = data.message || 'Login Successful!';
                      this.email = '';
                      
                      // Redirect after showing success message
                      setTimeout(() => {
                        this.loginSuccess = false;
                        // redirect to the route /attendance
                        window.location.href = '/attendance';
                      }, 1200);
                      // // After login, verify student is in the class for the current session
                      // const sessionRes = await fetch('/api/attendance-sessions/current/students');
                      // const sessionData = await sessionRes.json();
                      // const found = sessionData.students && sessionData.students.some(s => s.email.toLowerCase() === emailTrimmed.toLowerCase());
                      
                      // if (!found) {
                      //   this.showError("You are not in the class for the current attendance session.");
                      //   return;
                      // }
                      
                      // this.loginSuccess = true;
                      // this.successMessage = data.message || 'Login Successful!';
                      // this.email = '';
                      
                      // // Redirect after showing success message
                      // setTimeout(() => {
                      //   this.loginSuccess = false;
                      //   window.location.href = this.redirectUrl;
                      // }, 1200);
                    }
                    // Handle error response
                    else {
                      this.showError(data.message || "Login failed.");
                    }
                  } 
                  // Handle network/connection errors
                  catch (error) {
                    console.error("Fetch error:", error);
                    this.showError("Failed to connect to the server.");
                  } 
                  // Always reset submission status
                  finally {
                    this.isSubmitting = false;
                  }
                }
              }
            });
          </script>
      </body>
      
</body>