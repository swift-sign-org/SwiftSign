<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Enhanced Teacher Attendance Page</title>
  <link rel="icon" href="001.PNG" type="image/png">
  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Vue 3 CDN -->
  <script src="https://unpkg.com/vue@3"></script>

  <!-- Include your custom styles -->
  <link rel="stylesheet" href="style.css"> <!-- Assuming your CSS is named 'styles.css' -->

</head>
<body>
  <div id="app">
    <section>
      <div class="login-box">
        <div class="text-center mb-4">
          <h3>üìò Smart Attendance Portal</h3>
          <p class="mb-0">Session details auto-filled. Mark attendance easily!</p>
          <div class="timer" v-if="attendanceStarted">‚è≥ Session Duration: {{ formattedTime }}</div>
        </div>

        <form @submit.prevent>
          <div class="mb-3">
            <label class="form-label">Module Name</label>
            <select class="form-control" v-model="module" :disabled="attendanceStarted">
              <option v-for="mod in teacherModules" :key="mod">{{ mod }}</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Group</label>
            <select class="form-control" v-model="group" :disabled="attendanceStarted">
              <option v-for="grp in availableGroups" :key="grp">{{ grp }}</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Time Slot</label>
            <input type="text" class="form-control" :value="sessionTime" readonly>
          </div>

          <div class="mb-3">
            <label class="form-label">Date</label>
            <input type="text" class="form-control" :value="classDate" readonly>
          </div>

          <div class="d-grid gap-2 mb-3">
            <button type="button" class="btn btn-primary btn-custom" @click="startAttendance" :disabled="attendanceStarted">Start Attendance</button>
            <button type="button" class="btn btn-warning btn-custom" @click="endAttendance" v-if="attendanceStarted">End Attendance</button>
          </div>
        </form>

        <div class="report-box" v-if="attendanceStarted">
          <h5>üìã Attendance Sheet</h5>
          <table>
            <thead>
              <tr>
                <th>Student</th>
                <th>Self-Recorded</th>
                <th>Teacher Mark</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="student in students" :key="student.name">
                <td>{{ student.name }}</td>
                <td>{{ student.selfRecorded ? '‚úÖ' : '‚ùå' }}</td>
                <td>
                  <button class="btn btn-success btn-sm" @click="markAttendance(student, 'present')" :disabled="student.status === 'present' || !attendanceStarted">Present</button>
                  <button class="btn btn-danger btn-sm" @click="markAttendance(student, 'absent')" :disabled="student.status === 'absent' || !attendanceStarted">Absent</button>
                  <span v-if="!student.selfRecorded && !student.status" class="text-warning ms-2">(Manual mark needed)</span>
                </td>
              </tr>
            </tbody>
          </table>
          <div class="text-center mt-4">
            <button class="btn btn-outline-secondary" @click="downloadPDF">üìÑ Download PDF Report</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          module: '',
          group: '',
          teacherModules: (() => {
            try {
              return JSON.parse(localStorage.getItem('teacherSubjects')) || [];
            } catch (error) {
              console.error("Error parsing teacherSubjects from localStorage:", error);
              return [];
            }
          })(),
          availableGroups: ['all', 'G1', 'G2'],
          classDate: new Date().toISOString().slice(0, 10),
          isDarkMode: false,
          students: [],
          attendanceStarted: false,
          timer: 0,
          timerInterval: null,
          pollingInterval: null
        };
      },
      computed: {
        sessionTime() {
          const hour = new Date().getHours();
          const min = new Date().getMinutes();
          const time = hour + min / 60;
          if (time < 10) return '08:30 ‚Äì 10:00';
          if (time < 11.5) return '10:00 ‚Äì 11:30';
          if (time < 13) return '11:30 ‚Äì 13:00';
          if (time < 15.5) return '14:00 ‚Äì 15:30';
          return '15:30 ‚Äì 17:00';
        },
        formattedTime() {
          const minutes = Math.floor(this.timer / 60);
          const seconds = this.timer % 60;
          return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
      },
      methods: {
        toggleDarkMode() {
          this.isDarkMode = !this.isDarkMode;
          localStorage.setItem("darkMode", this.isDarkMode);
          document.body.classList.toggle('dark-mode', this.isDarkMode);
        },
        startAttendance() {
          fetch('/api/attendance-sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ module: this.module, group: this.group })
          })
          .then(res => res.json())
          .then(data => {
            if (data.message && data.message.includes('started')) {
              this.attendanceStarted = true;
              this.timer = 0;
              this.timerInterval = setInterval(() => { this.timer++; }, 1000);
              this.fetchStudents();
              this.pollingInterval = setInterval(this.fetchStudents, 3000);
            } else {
              alert(data.message || 'Failed to start session');
            }
          });
        },
        endAttendance() {
          fetch('/api/attendance-sessions/current/end', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          })
          .then(res => res.json())
          .then(data => {
            this.attendanceStarted = false;
            clearInterval(this.timerInterval);
            this.timerInterval = null;
            clearInterval(this.pollingInterval);
            this.pollingInterval = null;
          });
        },
        markAttendance(student, status) {
          fetch(`/api/attendance-sessions/current/students/${student.id}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status })
          })
          .then(res => res.json())
          .then(data => {
            student.status = status;
          });
        },
        fetchStudents() {
          fetch('/api/attendance-sessions/current/students')
            .then(res => res.json())
            .then(data => {
              this.students = data.students;
            });
        },
        downloadPDF() {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          doc.text(`Attendance Report`, 10, 10);
          doc.text(`Module: ${this.module}`, 10, 20);
          doc.text(`Group: ${this.group}`, 10, 30);
          doc.text(`Date: ${this.classDate}`, 10, 40);
          let y = 50;
          this.students.forEach(s => {
            doc.text(`${s.name} | Self: ${s.selfRecorded ? 'Yes' : 'No'} | Mark: ${s.status || 'Not Marked'}`, 10, y);
            y += 10;
          });
          doc.save(`Attendance_Report_${this.classDate}.pdf`);
        }
      },
      created() {
        const savedMode = localStorage.getItem("darkMode");
        if (savedMode === "true") {
          this.isDarkMode = true;
          document.body.classList.add("dark-mode");
        }
      },
      beforeUnmount() {
        if (this.timerInterval) {
          clearInterval(this.timerInterval);
        }
        if (this.pollingInterval) {
          clearInterval(this.pollingInterval);
        }
      }
    }).mount('#app');
  </script>
</body>
</html>
